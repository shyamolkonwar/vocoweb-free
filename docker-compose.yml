version: '3.8'

# ============================================
# Vocoweb Backend Docker Compose
# Starts: API + Celery Worker + Cloudflare Tunnel
# Frontend on Vercel connects via api.vocoweb.in
# ============================================

services:
  # =====================================
  # Backend API (FastAPI)
  # =====================================
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile.api
    container_name: vocoweb-api
    ports:
      - "8000:8000"
    env_file:
      - ./backend/.env
    dns:
      - 8.8.8.8
      - 8.8.4.4
    volumes:
      - website_data:/app/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =====================================
  # Celery Worker (AI Jobs)
  # Upstash-optimized settings
  # =====================================
  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.worker
    container_name: vocoweb-worker
    env_file:
      - ./backend/.env
    volumes:
      - website_data:/app/app/data
    depends_on:
      - api
    restart: unless-stopped

  # =====================================
  # Cloudflare Tunnel
  # Exposes local API to api.vocoweb.in
  # =====================================
  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: vocoweb-tunnel
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      # MEDIUM-008: Use env var instead of hardcoded path
      - ${CLOUDFLARED_CONFIG_PATH:-~/.cloudflared}:/etc/cloudflared:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - api
    restart: unless-stopped

volumes:
  website_data:

# ============================================
# Usage:
#   docker-compose up -d
#
# Services started (in order):
#   1. api - FastAPI on port 8000
#   2. worker - Celery for AI tasks
#   3. tunnel - Cloudflare tunnel to api.vocoweb.in
#
# Prerequisites:
#   - backend/.env configured (REDIS_URL, SUPABASE, CLOUDFLARE, OPENAI)
#   - ~/.cloudflared has your tunnel credentials
#   - Run 'cloudflared tunnel login' first if not set up
# ============================================
